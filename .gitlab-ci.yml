build:
  # Use the official docker image.
  image: docker
  variables:
    tag: CI_COMMIT_SHA
  # tags:
  #   - docker 
  #   - front 
  #   - purescript
  services:
    - docker:dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  # Default branch leaves tag empty (= latest tag)
  # All other branches are tagged with the escaped branch name (commit ref slug)
  script:
    - docker build --pull -t "$CI_REGISTRY_IMAGE:$tag" --build-arg build_image=ubuntu --build-arg build_node=node:18.16.0-alpine .
    - docker push "$CI_REGISTRY_IMAGE:$tag"

deploy:
  image: nixos/nix:2.3.4
  tags:
    - docker 
    - front 
    - purescript
  before_script:
    - nix-env -iA nixpkgs.docker
    - nix-env -iA nixpkgs.docker_compose
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  when: manual
  script:
    - docker pull $IMAGE_TAG_LATEST
    - docker-compose down
    - docker-compose up -d
  environment:
    name: Production
    url: http://178.62.15.173